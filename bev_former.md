# BEVFormer

<img width="2410" height="942" alt="Screenshot from 2025-09-21 19-01-24" src="https://github.com/user-attachments/assets/a222d9de-c507-4261-9551-9be71f861c34" />


**ä»¥å¾€çš„ç›¸æœºæ„ŸçŸ¥æ–¹æ³•ï¼ˆå¦‚FCOS3Dã€DETR3Dç­‰ï¼‰ä¸»è¦ä¾èµ–2Då›¾åƒç‰¹å¾ï¼Œéš¾ä»¥æœ‰æ•ˆæ•´åˆå¤šè§†è§’ä¿¡æ¯ï¼Œå°¤å…¶åœ¨é•¿è·ç¦»ã€é®æŒ¡å’Œè¿åŠ¨çŠ¶æ€ä¼°è®¡æ–¹é¢è¡¨ç°ä¸è¶³ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒBEVè¡¨ç¤ºå…·æœ‰è§†è§’ç»Ÿä¸€ã€ç»“æ„æ¸…æ™°çš„ä¼˜åŠ¿ï¼Œä¾¿äºä¸‹æ¸¸ä»»åŠ¡å¤„ç†ã€‚ç„¶è€Œï¼Œä»2Då›¾åƒç”Ÿæˆé«˜è´¨é‡BEVç‰¹å¾æ˜¯ä¸€ä¸ªç—…æ€é—®é¢˜ï¼Œä¼ ç»Ÿæ–¹æ³•å¸¸ä¾èµ–æ·±åº¦ä¼°è®¡ï¼Œæ˜“å—è¯¯å·®ç´¯ç§¯å½±å“ã€‚**

**BEVFormer çš„ç›®æ ‡æ˜¯é¿å…å¯¹æ·±åº¦ä¾èµ–ï¼Œç›´æ¥åˆ©ç”¨æ—¶ç©ºæ³¨æ„åŠ›æœºåˆ¶ä»å›¾åƒä¸­å­¦ä¹  BEV è¡¨å¾ã€‚**



**BEV Queriesï¼ˆBEVæŸ¥è¯¢ï¼‰**ï¼š

- å°†BEVç©ºé—´ç¦»æ•£æˆå›ºå®šç½‘æ ¼ï¼Œæ¯ä¸ªæ ¼å­ç”¨ä¸€ä¸ª**å¯å­¦ä¹ æŸ¥è¯¢å‘é‡**è¡¨ç¤ºï¼Œå½¢æˆä¸€ç»„BEV Queriesã€‚
- æ¯ä¸ªæŸ¥è¯¢é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶ä»å›¾åƒå’Œå†å²BEVä¸­æå–å¯¹åº”ä¿¡æ¯ã€‚

**Spatial Cross-Attentionï¼ˆç©ºé—´äº¤å‰æ³¨æ„åŠ›ï¼‰**ï¼š

- æ¯ä¸ªBEVæŸ¥è¯¢é€šè¿‡**Deformable Attention**æœºåˆ¶ï¼Œä»…ä»å›¾åƒä¸­**è§†é‡èŒƒå›´å†…çš„å…´è¶£åŒºåŸŸ**æå–ç‰¹å¾ï¼Œé¿å…äº†å…¨å±€æ³¨æ„åŠ›çš„é«˜è®¡ç®—å¼€é”€ã€‚
- åˆ©ç”¨ç›¸æœºå†…å¤–å‚å°†BEVåæ ‡æ˜ å°„åˆ°å„ä¸ªè§†è§’å›¾åƒä¸­ã€‚

**Temporal Self-Attentionï¼ˆæ—¶é—´è‡ªæ³¨æ„åŠ›ï¼‰**ï¼š

- æ¨¡æ‹ŸRNNä¸­çš„éšè—çŠ¶æ€ä¼ é€’ï¼Œåˆ©ç”¨**å†å²BEVç‰¹å¾**ä¸å½“å‰BEV Queriesäº¤äº’ï¼Œæ•æ‰ç›®æ ‡è¿åŠ¨ä¿¡æ¯ï¼Œæå‡é€Ÿåº¦ä¼°è®¡ä¸é®æŒ¡ç‰©æ£€æµ‹èƒ½åŠ›ã€‚
- è®¡ç®—æ•ˆç‡é«˜ï¼Œä»…ä½¿ç”¨ä¸Šä¸€ä¸ªæ—¶é—´å¸§çš„BEVï¼Œæ— éœ€å †å å¤šä¸ªæ—¶é—´å¸§ã€‚

**ä»»åŠ¡å¤´éƒ¨è®¾è®¡**ï¼š

- é‡‡ç”¨Deformable DETRç»“æ„è¿›è¡Œ3Dç›®æ ‡æ£€æµ‹ï¼Œç›´æ¥é¢„æµ‹ç›®æ ‡çš„ä¸‰ç»´ä½ç½®ã€å°ºå¯¸ã€æœå‘å’Œé€Ÿåº¦ã€‚
- åˆ†å‰²ä»»åŠ¡ä½¿ç”¨Panoptic SegFormerç»“æ„ï¼Œæ”¯æŒè¯­ä¹‰çº§åˆ«çš„åœ°å›¾åˆ†å‰²ï¼Œå¦‚é“è·¯ã€è½¦é“ã€è½¦è¾†ç­‰ã€‚


---

### âœ… è¾“å…¥ï¼š

- **å¤šæ‘„åƒå¤´å›¾åƒ**ï¼ˆ6ä¸ªè§†è§’ï¼Œæ¯å¸§ï¼‰ï¼š`Iâ‚œ = {Iâ‚œÂ¹, Iâ‚œÂ², ..., Iâ‚œâ¶}`

- **å‰ä¸€æ—¶åˆ»çš„ BEV ç‰¹å¾**ï¼š`Bâ‚œâ‚‹â‚`ï¼ˆtâˆ’1 æ—¶åˆ»ï¼‰

- **ç›¸æœºå‚æ•°**ï¼šæ¯ä¸ªæ‘„åƒå¤´çš„å†…å‚å’Œå¤–å‚

  

### ğŸ§± Step 1ï¼šå›¾åƒç¼–ç ï¼ˆBackbone æå–ç‰¹å¾ï¼‰

ä½¿ç”¨å…±äº«ä¸»å¹²ç½‘ç»œï¼ˆå¦‚ ResNet101 + FPNï¼‰å¯¹æ¯ä¸ªæ‘„åƒå¤´å›¾åƒæå–å¤šå°ºåº¦ç‰¹å¾ï¼š

```
Fâ‚œ = {Fâ‚œÂ¹, Fâ‚œÂ², ..., Fâ‚œâ¶}
```



### ğŸ§© Step 2ï¼šåˆå§‹åŒ– BEV Queries

- åˆ›å»ºä¸€ä¸ªå½¢çŠ¶ä¸º `HÃ—W` çš„ **BEV Query ç½‘æ ¼**ï¼ˆå¦‚ 200Ã—200ï¼‰ï¼Œæ¯ä¸ªä½ç½®ä¸€ä¸ª Learnable Embeddingï¼Œä»£è¡¨ BEV ç©ºé—´ä¸­çš„ä¸€ä¸ªç½‘æ ¼å•å…ƒã€‚

- æ·»åŠ ä½ç½®ç¼–ç ï¼ˆPosition Embeddingï¼‰

  ###  ğŸ” Step 3ï¼šBEVFormer ç¼–ç å™¨ï¼ˆå…± 6 å±‚ï¼Œæ¯å±‚æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼‰

  #### a. **Temporal Self-Attentionï¼ˆæ—¶é—´è‡ªæ³¨æ„åŠ›ï¼‰**

  - ç›®æ ‡ï¼šèåˆ `Bâ‚œâ‚‹â‚` çš„æ—¶é—´ä¿¡æ¯
  - å°† `Bâ‚œâ‚‹â‚` ä¸å½“å‰ BEV Queries `Q` å¯¹é½ï¼ˆä½¿ç”¨ ego-motionï¼‰ï¼Œä½œä¸ºæ³¨æ„åŠ›é”®å€¼å¯¹ï¼Œç¬¬ä¸€å¸§ç”¨è‡ªèº«ã€‚
  - æ¯ä¸ª BEV Query ä» `Bâ‚œâ‚‹â‚` ä¸­æå–è¿åŠ¨ä¸å†å²çº¿ç´¢
    
   'norm',  'norm', 
  #### b. **Spatial Cross-Attentionï¼ˆç©ºé—´äº¤å‰æ³¨æ„åŠ›ï¼‰**

  - æ¯ä¸ª BEV Queryï¼š
    - åœ¨ BEV å¹³é¢(å¯ä»¥æ˜ å°„åˆ°xy)ä¸Šå‡æˆä¸€ä¸ªæŸ±ä½“ï¼ˆå¤šä¸ªé«˜åº¦ç‚¹ï¼‰
    - åˆ©ç”¨ç›¸æœºæŠ•å½±çŸ©é˜µå°†æŸ±ä½“æŠ•å½±åˆ°å›¾åƒå¹³é¢ï¼Œå¾—åˆ°å¤šä¸ª 2D å‚è€ƒç‚¹ï¼ˆreference pointsï¼‰
    - ä½¿ç”¨ **Deformable Attention** ä»å‘½ä¸­çš„å›¾åƒç‰¹å¾åŒºåŸŸä¸­é‡‡æ ·
    - æ±‡æ€»å¤šä¸ªæ‘„åƒå¤´çš„ä¿¡æ¯
    - å…ˆç»´åº¦æ‹å¹³ï¼Œæ¯ä¸ªç›¸æœºçš„ 2D ç‰¹å¾å›¾è¢«æ‹‰å¹³æˆä¸€ç»„ token åºåˆ— ï¼šfeat.shape = (2, 6, 256, 30, 40) -> feat.flatten(3) â†’ (2, 6, 256, 1200)
    ï¼ˆ6 = ç›¸æœºæ•° 2 = batch 1200 = flatten åçš„ç©ºé—´åƒç´ ç‚¹ 256 = é€šé“ï¼‰
    - åŠ ç›¸æœº/å±‚çº§ embeddingï¼šcams_embedså‘Šè¯‰æ¨¡å‹è¿™æ˜¯å‰è§†è¿˜æ˜¯åè§†ã€‚ self.level_embedsï¼šå‘Šè¯‰æ¨¡å‹è¿™æ˜¯ C4 è¿˜æ˜¯ C5ã€‚
    - C4 flatten â†’ (6, 2, 1200, 256) C5 flatten â†’ (6, 2, 300, 256)

  #### c. **Feed Forward + LayerNorm**

  - å¯¹æ¯ä¸ª BEV Query ç‰¹å¾è¿›è¡Œå‰é¦ˆç½‘ç»œå’Œè§„èŒƒåŒ–å¤„ç†
  - è¾“å‡ºæ–°çš„ BEV ç‰¹å¾ `Bâ‚œ`ï¼Œä½œä¸ºä¸‹ä¸€å±‚è¾“å…¥æˆ–æœ€ç»ˆç»“æœ
